name: Unpack content ZIPs

# Triggers:
# - When zips are added/changed under content/
# - Manual run (workflow_dispatch)
on:
  push:
    paths:
      - 'content/**'
  workflow_dispatch:
    inputs:
      branch:
        description: 'Target branch to push to (leave empty to use current branch)'
        required: false
        default: 'main'

permissions:
  contents: write

jobs:
  unpack-zips:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository 
        uses: actions/checkout@v4

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Find and unpack ZIP files under content/
        shell: bash
        run: |
          set -euo pipefail

          # Determine target branch (either input or current branch)
          TARGET_BRANCH="${{ inputs.branch }}"
          if [ -z "$TARGET_BRANCH" ]; then
            if [[ "${GITHUB_REF:-}" == refs/heads/* ]]; then
              TARGET_BRANCH="${GITHUB_REF#refs/heads/}"
            else
              TARGET_BRANCH="HEAD"
            fi
          fi
          echo "Target branch: $TARGET_BRANCH"

          # Find zip files under content/ (any depth). Use -print0 to safely handle spaces/newlines.
          mapfile -d '' zips < <(find content -type f -iname '*.zip' -print0)

          # If no zips found, exit cleanly
          if [ "${#zips[@]}" -eq 0 ]; then
            echo "No .zip files found under content/. Nothing to do."
            exit 0
          fi

          echo "Found ${#zips[@]} zip(s) — processing..."
          for zip in "${zips[@]}"; do
            zip="${zip/#.\//}"
            echo "Processing: '$zip'"

            fname="$(basename -- "$zip")"
            base="${fname%.[Zz][Ii][Pp]}"

            tmpdir="$(mktemp -d)"
            echo "Extracting '$zip' to temp dir..."
            unzip -q "$zip" -d "$tmpdir" || { echo "Failed to unzip $zip"; exit 1; }

            # Count top-level entries inside zip
            mapfile -t top_entries < <(ls -1 "$tmpdir")

            if [ "${#top_entries[@]}" -eq 1 ] && [ -d "$tmpdir/${top_entries[0]}" ]; then
              # Zip already has a single root folder → move it
              final_dest="content/${top_entries[0]}"
              echo "Zip contains root folder '${top_entries[0]}', moving to '$final_dest'"

              mkdir -p "content"
              rm -rf "$final_dest"
              mv "$tmpdir/${top_entries[0]}" "$final_dest"
            else
              # Zip contains loose files → create folder from zip name
              final_dest="content/$base"
              echo "Zip contains loose files, creating '$final_dest'"

              mkdir -p "$final_dest"
              mv "$tmpdir"/* "$final_dest"/
            fi

            rm -rf "$tmpdir"
            rm -f "$zip"
          done
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site for GitHub Pages
        run: npm run build:ghpages

      - name: Add, commit and push changes
        run: |
          # Determine branch (the branch that triggered the workflow)
          CURRENT_BRANCH="${GITHUB_REF#refs/heads/}"
          echo "Pushing to branch: $CURRENT_BRANCH"

          git add -A

          # If no changes staged, exit gracefully
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Auto-update from GitHub Actions"

          # Push to same branch
          git push origin HEAD:$CURRENT_BRANCH

      # - name: Deploy to gh-pages branch
      #   uses: peaceiris/actions-gh-pages@v3
      #   with:
      #     # You can keep github_token (auto-provided) for public repos.
      #     # For private repos you may need to use a PAT stored in secrets.
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: ./docs